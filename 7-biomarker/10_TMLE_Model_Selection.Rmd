---
title: |
  SL Model Selection
author: "Sajia Darwish"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(sl3)
library(kableExtra)
library(knitr)
library(skimr)
library(tidyverse)
library(data.table)
library(sl3)
library(SuperLearner)
library(origami)
library(hal9001)
library(polspline)
```

```{r message=FALSE, warning=FALSE}
slModelFunc <- function(data, covars, outcome) {
  
  # create the sl3 task
  task <- make_sl3_Task(
  data = data,
  covariates = covars,
  outcome = outcome
  )
  #dput(sl3_list_learners(c("continuous")))
  
  lrnr_glm <- make_learner(Lrnr_glm)
  lrnr_mean <- make_learner(Lrnr_mean)
  lrnr_glmtree <- make_learner(Lrnr_glmtree)
  lrnr_ranger100 <- make_learner(Lrnr_ranger, num.trees = 100)
  lrnr_gam <- Lrnr_pkg_SuperLearner $ new("SL.gam")
  lrnr_bayesglm <- Lrnr_pkg_SuperLearner$new("SL.bayesglm")
  lrn_ridge <- Lrnr_glmnet $ new(alpha = 0)
  lrn_lasso <- Lrnr_glmnet $ new(alpha = 1)
  # spline regressions:
  lrn_polspline <- Lrnr_polspline $ new()
  lrn_earth <- Lrnr_earth $ new()
  # fast highly adaptive lasso (HAL) implementation
  lrn_hal <- Lrnr_hal9001 $ new(max_degree = 2, num_knots = c(3,2), nfolds = 5)
  # tree-based methods
  lrn_ranger <- Lrnr_ranger $ new()
  lrn_xgb <- Lrnr_xgboost $ new()
  
  stack <- make_learner(
    Stack,
    lrnr_glm, lrnr_mean, lrnr_glmtree, 
    lrnr_ranger100, lrnr_gam,
    lrnr_gam, lrnr_bayesglm, lrn_ridge,
    lrn_lasso, lrn_polspline, lrn_earth,
    lrn_hal, lrn_ranger, lrn_xgb
  )
  
  metalearner <- make_learner(Lrnr_nnls)
  
  sl <- make_learner(Lrnr_sl,
    learners = stack,
    metalearner = metalearner
  )
  
  sl_fit <- sl $ train(task)
  
  sl_preds <- sl_fit $ predict()
  results <- sl_fit $ print()

  return(results)
}
```

# Use the function on datasets
```{r}
# Load data
hmo <- readRDS("/data/imic/data/raw_lab_data/elicit/merged_elicit/hmoClean.RDS")
#dput(names((hmo)))
#head(data)

covars = c("X2.FL_nmol.mL", "X3FL_nmol.mL", "DFLac_nmol.mL", "X3.SL_nmol.mL",
       "X6.SL_nmol.mL", "LNT_nmol.mL", "LNnT_nmol.mL", "LNFP.I_nmol.mL", 
       "LNFP.II_nmol.mL", "LNFP.III_nmol.mL", "LSTb_nmol.mL", "LSTc_nmol.mL",
       "DFLNT_nmol.mL", "LNH_nmol.mL", "DSLNT_nmol.mL", "FLNH_nmol.mL", 
       "DFLNH_nmol.mL", "FDSLNH_nmol.mL", "DSLNH_nmol.mL", "SUM_nmol.mL", 
       "Sia_nmol.mL", "Fuc_nmol.mL")
outcome = "haz_6m_simulated"

set.seed(4197)
start_time <- proc.time() # start time
slModelFunc(hmo, covars = covars, outcome = outcome)
runtime_sl_fit <- proc.time() - start_time # end time - start time = run time
runtime_sl_fit
```


