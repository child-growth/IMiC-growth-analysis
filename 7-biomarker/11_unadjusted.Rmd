---
title: |
  Unadjusted Analyses
author: "Sajia Darwish"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

# Unadjusted analyses: Elicit
```{r}
library(tidyverse)
library(broom)

data <- read.csv("/data/imic/data/raw_lab_data/elicit/merged_elicit/longDataset.csv")

df <- data %>% 
  select(haz_6m, biomarker, value) %>%
  filter(complete.cases(.)) %>%
  droplevels()

# With a log-transformed outcome: Elicit
df $ value[df $ value == 0] <- df $ value[df $ value == 0] + 0.01 
df $ log_value <- log(df $ value)
summary(df $ log_value)

# Group data by biomarker and then apply linear regression, predicting the growth from the biomarker
res <- df %>% 
  group_nest(biomarker ) %>% 
  mutate(fit = map(data, ~ lm(haz_6m ~ log_value, data = .)),
         results = map(fit, tidy)) %>%
  unnest(results) %>%
  filter(term != "(Intercept)") #drop intercept term and just keep the coefficient on the biomarker concentration

# Sort results
res <- res[order(res $ p.value, decreasing = FALSE), ]

# Adjusted p-value
res $ BH <- p.adjust(res $ p.value, method = "BH", n = length(res $ p.value))

#dput(names(res2))

res <- res %>%
  select(c("biomarker", "estimate", "std.error", "statistic", "p.value", "BH"))

write.csv(res, file = "/data/imic/results/unadjustedElicit.csv")
```

# Vital
```{r}
data <- read.csv("/data/imic/data/raw_lab_data/vital/merged_vital/longDataset.csv")

df <- data %>% 
  select(haz_m6, biomarker, value) %>%
  filter(complete.cases(.)) %>%
  droplevels()

# With a log-transformed outcome: Elicit
df $ value[df $ value == 0] <- df $ value[df $ value == 0] + 0.01 
df $ log_value <- log(df $ value)
summary(df $ log_value)

#Group data by biomarker and then apply linear regression, predicting the growth from the biomarker
res <- df %>% 
  group_nest(biomarker ) %>% 
  mutate(fit = map(data, ~ lm(haz_m6 ~ log_value, data = .)),
         results = map(fit, tidy)) %>%
  unnest(results) %>%
  filter(term != "(Intercept)") #drop intercept term and just keep the coefficient on the biomarker concentration

# Sort results
res <- res[order(res $ p.value, decreasing = FALSE), ]

# Adjusted p-value
res $ BH <- p.adjust(res $ p.value, method = "BH", n = length(res $ p.value))

#dput(names(res2))

res <- res %>%
  select(c("biomarker", "estimate", "std.error", "statistic", "p.value", "BH"))

write.csv(res, file = "/data/imic/results/unadjustedVital.csv")
```

# Limma
```{r}
library(limma)
library(tidyverse)
library(EnhancedVolcano)

data <- read.csv("/data/imic/data/raw_lab_data/elicit/merged_elicit/wideDataset.csv")

## Make design matrix that will be fed into limma - Must be nxp.
data $ haz_6mBinary <- ifelse(data $ haz_6m > median(data $ haz_6m), 1, 0)

data <- data[1:199, ]

design <- model.matrix(~ 0 + data $ haz_6m, data = data)

# Make matrix of log-transformed biomarkers (rows are the observations)
biomarkerMatrix <- data %>%
  select(!c(X, haz_6m, haz_6mBinary)) %>%
  as.matrix()

# Take the log
biomarkerLogMatrix <- log(biomarkerMatrix)

# Transpose the matrix to be able to fit linear model
biomarkerLogMatrix <- t(biomarkerLogMatrix)

## Does the limmat fit - experHS is a matrix of n (subject) rows and p (biomarker) columns.
fit <- lmFit(biomarkerLogMatrix, design)

## Derives the empirical Bayes SE's for more robust inference
ebayes <- eBayes(fit)

# Number of biomarkers (p)
nprobes = dim(biomarkerLogMatrix)[1]

## Creates a result table where you draw the parameter estimate from each of the fits - does FDR adjustment.
tt1 = topTable(ebayes, adjust.method = "fdr",
             number = nprobes, genelist = rownames(biomarkerLogMatrix))

# Make a volcano plot
EnhancedVolcano(ebayes,
    lab = rownames(ebayes),
    x = 'coefficients',
    y = 'p.value',
    xlim = c(-5, 5),
    pCutoff = 10e-16,
    pointSize = 1.0,
    FCcutoff = 0.5,
    labSize = 4)
```










