---
title: |
  Unadjusted Analyses
author: "Sajia Darwish"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

# Load libraries
```{r}
library(tidyverse)
library(broom)
library(limma)
library(EnhancedVolcano)
```

# Limma function
```{r}
limmaFunc <- function(data, outcome, matrix){
  
    # Make design matrix that will be fed into limma - Must be nxp.
    design <- model.matrix(~ 0 + outcome, data = data)
    
    # Take the log
    biomarkerLogMatrix <- log(matrix)
    
    # Transpose the matrix to be able to fit linear model
    biomarkerLogMatrix <- t(biomarkerLogMatrix)
    
    ## Does the limmat fit - experHS is a matrix of n (subject) rows and p (biomarker) columns.
    fit <- lmFit(biomarkerLogMatrix, design)
    
    ## Derives the empirical Bayes SE's for more robust inference
    ebayes <- eBayes(fit)
    
    # Number of biomarkers (p)
    nprobes = dim(biomarkerLogMatrix)[1]
    
    ## Creates a result table where you draw the parameter estimate from each of the fits - does FDR adjustment.
    tt1 = topTable(ebayes, adjust.method = "fdr",
                 number = nprobes, genelist = rownames(biomarkerLogMatrix))
    
    # Make a volcano plot
    volcanoPlot <- EnhancedVolcano(ebayes,
        lab = rownames(ebayes),
        x = 'coefficients',
        y = 'p.value',
        xlim = c(-5, 5),
        pCutoff = 10e-16,
        pointSize = 1.0,
        FCcutoff = 0.5,
        labSize = 4)

    return(volcanoPlot)
}
```

# Limma Elicit
```{r}
wide <- read.csv("/data/imic/data/raw_lab_data/elicit/merged_elicit/wideDataset.csv")

wide $ haz_6mBinary <- ifelse(wide $ haz_6m_simulated > 
                                median(wide $ haz_6m_simulated, na.rm = TRUE), 1, 0)

id <- c("X", "bmid_base", "country", "studyid", "subjid", "subjido", 
            "arm_base", "sex_base", "brthyr_base", "brthweek_base", "mage_base", 
            "parity_base", "nlchild_base", "nperson_base", "nrooms_base", 
            "meducyrs_base", "h2osrcp_base", "cookplac_base", "epoch_base", 
            "mhtcm_base", "mwtkg_base", "mbmi_base", "dlvloc_base", "wtkg_base", 
            "lencm_base", "bmi_base", "waz_base", "haz_base", "whz_base", 
            "baz_base", "agedays_base", "dur_bf_base", "dur_ebf_base", "haz_6m", 
            "haz_6m_simulated", "haz_6mBinary", "family")

# Make matrix of log-transformed biomarkers (rows are the observations)
biomarkerMatrix <- wide %>%
  select(!id) %>%
  as.matrix()

# Run the function and save the plot
volcanoPlotElicit <- limmaFunc(data = wide, matrix = biomarkerMatrix, outcome = wide $ haz_6m)

ggsave(volcanoPlotElicit, filename = "/data/imic/results/figures/volcanoPlotElicit.png")

## Bvit
bvit <- wide %>%
  filter(family == "bvit")

# Make matrix of log-transformed biomarkers (rows are the observations)
biomarkerMatrix <- bvit %>%
  select(!id) %>%
  as.matrix()

# Run the function and save the plot
volcanoPlotBvitElicit <- limmaFunc(data = bvit, matrix = biomarkerMatrix, 
                               outcome = bvit $ haz_6m_simulated)

ggsave(volcanoPlotBvitElicit, filename = "/data/imic/results/figures/volcanoPlotElicit.png")
```

# Limma Vital
```{r}
wide <- read.csv("/data/imic/data/raw_lab_data/vital/merged_vital/wideDataset.csv")

dput(names(wide)[1:100])

wide $ haz_6mBinary <- ifelse(wide $ haz_6m_simulated > 
                                median(wide $ haz_6m_simulated), 1, 0)

# Make matrix of log-transformed biomarkers (rows are the observations)
biomarkerMatrix <- wide %>%
  select(!c("X", "bmid_base", "subjid", "country", "studyid", "subjido", 
            "arm_base", "sex_base", "brthyr_base", "brthweek_base", "mage_base", 
            "parity_base", "nlchild_base", "nperson_base", "nrooms_base", 
            "meducyrs_base", "h2osrcp_base", "agedays_base", "epochn_base", 
            "epoch_base", "mhtcm_base", "mwtkg_base", "mbmi_base", "dlvloc_base", 
            "wtkg_base", "lencm_base", "bmi_base", "muaccm_base", "waz_base", 
            "haz_base", "whz_base", "baz_base", "feeding_base", "dur_bf_base", 
            "dur_ebf_base", "visit_r_fl_base", "dur_r_base", "fever_r_base", 
            "cough_r_base", "anti_r_base", "citytown_base", "gagebrth_base", 
            "gagecm_base", "birthwt_base", "birthlen_base", "birthord_base", 
            "gravida_base", "nlivbrth_base", "floor_base", "gagedays_base", 
            "postbmi_base", "mmuaccm_base", "delivery_base", "bfinittm_base", 
            "cmfdint_base", "formlkfl_base", "fever_base", "diarr_base", 
            "physican_base", "hosp_base", "antibiot_base")) %>%
  as.matrix()

# Run the function and save the plot
volcanoPlotVital <- limmaFunc(data = wide, matrix = biomarkerMatrix, outcome = wide $ haz_6m)

ggsave(volcanoPlotVital, filename = "/data/imic/results/figures/volcanoPlotVital.png")
```

# Meta-analysis
```{r}
longE <- read.csv("/data/imic/data/raw_lab_data/elicit/merged_elicit/longDataset.csv")
longV <- read.csv("/data/imic/data/raw_lab_data/vital/merged_vital/longDataset.csv")

# Test: filter both datasets by hmo
longE <- longE %>%
  select(c("haz_6m", "family", "biomarker", "value", "site")) %>%
  filter(family == "hmo")

longV $ haz_6m <- longV $ haz_6m

longV <- longV %>%
  select(c("haz_6m", "family", "biomarker", "value", "site")) %>%
  filter(family == "hmo")

dput(names(longV))

# Bind together
long <- rbind(longE, longV)
names(long)
```


```{r}
# Load required packages
library(limma)
library(metafor)

# Read in data
data <- long

# Convert outcome to log scale
data$log_outcome <- log(data$haz_6m)

# Convert outcome to binary variable based on median
data$group <- ifelse(data$log_outcome >= median(data$log_outcome, na.rm = TRUE),
                     1, 0)

# Perform differential expression analysis by site for each biomarker family
results_by_site <- lapply(unique(data$family), function(family) {
  family_data <- data[data$family == family,]
  family_results <- data.frame()
  for (site in unique(family_data$site)) {
    site_data <- family_data[family_data$site == site,]
    if (!"group" %in% colnames(site_data)) {
      stop("Group variable not found in site data for site ", site)
    }
    if (any(is.na(site_data$group))) {
      # Impute missing values with median value
      site_data$group[is.na(site_data$group)] <- median(site_data$group, na.rm=TRUE)
      message("Imputed ", sum(is.na(site_data$group)), " missing values in group variable for site ", site)
    }
    # Remove missing values before constructing design matrix
    site_data <- site_data[complete.cases(site_data),]
    if (nrow(site_data) == 0) {
      warning("No complete cases in site data for site ", site, " and biomarker family ", family)
      next
    }
    design <- model.matrix(~ site_data$group)
    fit <- lmFit(site_data$log_outcome, design)
    fit <- eBayes(fit)
    de_results <- topTable(fit, coef=2, adjust.method="fdr", sort.by="logFC")
    de_results$site <- site
    de_results$family <- family
    if ("weight" %in% colnames(fit$coefficients)) {
      de_results$weight <- fit$coefficients[, "weight"]
    } else {
      de_results$weight <- rep(1, nrow(de_results))
    }
    family_results <- rbind(family_results, de_results)
  }
  return(family_results)
})

# Perform meta-analysis by biomarker family for each site
meta_results <- lapply(unique(data$family), function(family) {
  family_results <- do.call(rbind, results_by_site)[do.call(rbind, results_by_site)$family == family,]
  if (nrow(family_results) == 0) {
    warning("No results for biomarker family ", family, " in any site")
    return(NULL)
  }
  
  # Impute missing values in logFC.se column with a default value of 1
  if (any(is.na(family_results$logFC.se))) {
    family_results$logFC.se[is.na(family_results$logFC.se)] <- 1
    message("Imputed ", sum(is.na(family_results$logFC.se)), " missing values in logFC.se column for biomarker family ", family)
  }
  
  meta_fit <- rma.uni(yi=family_results$logFC, vi=family_results$logFC.se^2, weights=family_results$weight)
  meta_de_results <- data.frame(biomarker=family, logFC=coef(meta_fit), logFC.se=sqrt(vc(meta_fit)), pval=1-pt(abs(coef(meta_fit))/sqrt(vc(meta_fit)), df=meta_fit$k-1))
  return(meta_de_results)
})
```

# Unadjusted analyses: Elicit
```{r}
data <- read.csv("/data/imic/data/raw_lab_data/elicit/merged_elicit/longDataset.csv")

names(data)

df <- data %>% 
  select(haz_6m, biomarker, value) %>%
  filter(complete.cases(.)) %>%
  droplevels()

# With a log-transformed outcome: Elicit
df $ value[df $ value == 0] <- df $ value[df $ value == 0] + 0.01 
df $ log_value <- log(df $ value)
summary(df $ log_value)

# Group data by biomarker and then apply linear regression, predicting the growth from the biomarker
res <- df %>% 
  group_nest(biomarker ) %>% 
  mutate(fit = map(data, ~ lm(haz_6m ~ log_value, data = .)),
         results = map(fit, tidy)) %>%
  unnest(results) %>%
  filter(term != "(Intercept)") #drop intercept term and just keep the coefficient on the biomarker concentration

# Sort results
res <- res[order(res $ p.value, decreasing = FALSE), ]

# Adjusted p-value
res $ BH <- p.adjust(res $ p.value, method = "BH", n = length(res $ p.value))

#dput(names(res2))

res <- res %>%
  select(c("biomarker", "estimate", "std.error", "statistic", "p.value", "BH"))

write.csv(res, file = "/data/imic/results/unadjustedElicit.csv")
```

# Vital
```{r}
data <- read.csv("/data/imic/data/raw_lab_data/vital/merged_vital/longDataset.csv")

df <- data %>% 
  select(haz_m6, biomarker, value) %>%
  filter(complete.cases(.)) %>%
  droplevels()

# With a log-transformed outcome: Elicit
df $ value[df $ value == 0] <- df $ value[df $ value == 0] + 0.01 
df $ log_value <- log(df $ value)
summary(df $ log_value)

#Group data by biomarker and then apply linear regression, predicting the growth from the biomarker
res <- df %>% 
  group_nest(biomarker ) %>% 
  mutate(fit = map(data, ~ lm(haz_m6 ~ log_value, data = .)),
         results = map(fit, tidy)) %>%
  unnest(results) %>%
  filter(term != "(Intercept)") #drop intercept term and just keep the coefficient on the biomarker concentration

# Sort results
res <- res[order(res $ p.value, decreasing = FALSE), ]

# Adjusted p-value
res $ BH <- p.adjust(res $ p.value, method = "BH", n = length(res $ p.value))

#dput(names(res2))

res <- res %>%
  select(c("biomarker", "estimate", "std.error", "statistic", "p.value", "BH"))

write.csv(res, file = "/data/imic/results/unadjustedVital.csv")
```






