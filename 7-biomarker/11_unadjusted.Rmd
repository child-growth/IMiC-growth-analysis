---
title: |
  Unadjusted Analyses
author: "Sajia Darwish"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  pdf_document:
    toc: yes
    toc_depth: '4'
  html_document:
    toc: yes
    toc_depth: 4
keep_tex: yes
theme: bclear
fontsize: 12pt
geometry: margin=1in
header-includes:
- \usepackage{enumitem}
- \usepackage{indentfirst}
- \usepackage[default, scale=1]{raleway}
- \usepackage[T1]{fontenc}
- \usepackage{inconsolata}
always_allow_html: yes
---

# Unadjusted analyses: Elicit
```{r}
library(tidyverse)
library(broom)

data <- read.csv("/data/imic/data/raw_lab_data/elicit/merged_elicit/longDataset.csv")

table(is.na(data$value))

df <- data %>% select(haz_6m, biomarker, value) %>% filter(complete.cases(.)) %>% droplevels()
summary(df$haz_6m)
summary(df$value)

#Group data by biomarker and then apply linear regression, predicting the growth from the biomarker
res <- df %>% 
  group_nest(biomarker ) %>% 
  mutate(fit = map(data, ~ lm(haz_6m ~ value, data = .)),
         results = map(fit, tidy)) %>% 
  unnest(results) %>%
  filter(term!="(Intercept)") #drop intercept term and just keep the coefficient on the biomarker concentration

# Sort results
res <- res[order(res$p.value, decreasing=FALSE), ]

# Adjusted p-value
res $ hochberg <- p.adjust(res $ p.value, method = "hochberg", n = length(res $ p.value))

res <- res %>%
  select(c("biomarker", "estimate", "std.error", "statistic", "p.value", "hochberg"))

# With a log-transformed outcome: Elicit
#We may want to use a log-transformed outcome as it seems to have a more normal distribution
df$value[df$value==0] <- df$value[df$value==0] + 0.01 
df$log_value <- log(df$value)
summary(df$log_value)

#Group data by biomarker and then apply linear regression, predicting the growth from the biomarker
res2 <- df %>% 
  group_nest(biomarker ) %>% 
  mutate(fit = map(data, ~ lm(haz_6m ~ log_value, data = .)),
         results = map(fit, tidy)) %>%
  unnest(results) %>%
  filter(term!="(Intercept)") #drop intercept term and just keep the coefficient on the biomarker concentration

# Sort results
res2 <- res2[order(res2$p.value, decreasing=FALSE), ]

# Adjusted p-value
res2 $ hochberg <- p.adjust(res2 $ p.value, method = "hochberg", n = length(res2 $ p.value))

#dput(names(res2))

res2 <- res2 %>%
  select(c("biomarker", "estimate", "std.error", "statistic", "p.value", "hochberg"))

# Add _log for all column names
colnames(res2) <- paste(colnames(res2),"log",sep="_")
colnames(res2)[1] <- "biomarker"

# Merge the datasets by biomarker
res3 <- merge(res, res2, by = "biomarker", all = TRUE)

res3 <- res3[order(res3$p.value, decreasing=FALSE), ]

#write.csv(res3, file = "/data/imic/results/unadjustedElicit.csv")
```

# Vital
```{r}
data <- read.csv("/data/imic/data/raw_lab_data/vital/merged_vital/longDataset.csv")

table(is.na(data$value))

df <- data %>% select(haz_m6, biomarker, value) %>% filter(complete.cases(.)) %>% droplevels()
summary(df$haz_m6)
summary(df$value)

#Group data by biomarker and then apply linear regression, predicting the growth from the biomarker
res <- df %>% 
  group_nest(biomarker ) %>% 
  mutate(fit = map(data, ~ lm(haz_m6 ~ value, data = .)),
         results = map(fit, tidy)) %>% 
  unnest(results) %>%
  filter(term!="(Intercept)") #drop intercept term and just keep the coefficient on the biomarker concentration

# Sort results
res <- res[order(res$p.value, decreasing=FALSE), ]

# Adjusted p-value
res $ hochberg <- p.adjust(res $ p.value, method = "hochberg", n = length(res $ p.value))

res <- res %>%
  select(c("biomarker", "estimate", "std.error", "statistic", "p.value", "hochberg"))

# With a log-transformed outcome: Elicit
#We may want to use a log-transformed outcome as it seems to have a more normal distribution
df$value[df$value==0] <- df$value[df$value==0] + 0.01 
df$log_value <- log(df$value)
summary(df$log_value)

#Group data by biomarker and then apply linear regression, predicting the growth from the biomarker
res2 <- df %>% 
  group_nest(biomarker ) %>% 
  mutate(fit = map(data, ~ lm(haz_m6 ~ log_value, data = .)),
         results = map(fit, tidy)) %>%
  unnest(results) %>%
  filter(term!="(Intercept)") #drop intercept term and just keep the coefficient on the biomarker concentration

# Sort results
res2 <- res2[order(res2$p.value, decreasing=FALSE), ]

# Adjusted p-value
res2 $ hochberg <- p.adjust(res2 $ p.value, method = "hochberg", n = length(res2 $ p.value))

#dput(names(res2))

res2 <- res2 %>%
  select(c("biomarker", "estimate", "std.error", "statistic", "p.value", "hochberg"))

# Add _log for all column names
colnames(res2) <- paste(colnames(res2),"log",sep="_")
colnames(res2)[1] <- "biomarker"

# Merge the datasets by biomarker
res3 <- merge(res, res2, by = "biomarker", all = TRUE)

res3 <- res3[order(res3$p.value, decreasing=FALSE), ]

write.csv(res3, file = "/data/imic/results/unadjustedVital.csv")
```












