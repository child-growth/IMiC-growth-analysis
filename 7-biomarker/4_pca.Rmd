---
title: |
  |Principal Component Analysis
author: "Sajia Darwish"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: yes
    toc_depth: 4
  pdf_document:
    toc: yes
    toc_depth: '4'
keep_tex: yes
theme: bclear
fontsize: 10pt
geometry: margin=1in
header-includes:
- \usepackage{enumitem}
- \usepackage{indentfirst}
- \usepackage[default, scale=1]{raleway}
- \usepackage[T1]{fontenc}
- \usepackage{inconsolata}
always_allow_html: yes
---

```{r, echo=FALSE}
# remove.packages("rlang")
# install.packages("rlang")
rm(list=ls())
source(paste0(here::here(), "/0-config.R"))

library(tidyverse)
library(tidymodels)
library(corrplot)
library(ggrepel)
library(tidytext)
library(dotwhisker) # for coefficient plots.

# Load ELICIT datasets
# hmo <- read.csv("/data/KI/imic/data/raw_lab_data/elicit/milk_analytes/HMO_ELICIT.csv")
# hmo <- rename("bmid" = "X", hmo)
# 
# bvit <- read.csv("/data/KI/imic/data/raw_lab_data/elicit/milk_analytes/Allen_Bvit_ELICIT.csv")
# bvit <- rename("bmid_base" = "X", bvit)
# 
biocratesNormE <- read.csv("/data/KI/imic/data/raw_lab_data/elicit/milk_analytes/Biocrates_ELICIT_Normalized_toALL_NS.csv")
biocratesNormE <- rename("bmid_base" = "X", biocratesNormE)
#
# sapient <- read.csv("/data/KI/imic/data/raw_lab_data/elicit/milk_analytes/Sapient_ELICIT.csv")
# sapient <- rename("bmid_base" = "X", sapient)
#
# biocrates <- read.csv("/data/KI/imic/data/raw_lab_data/elicit/milk_analytes/Biocrates_ELICIT_NOT_Normalized.csv")
# biocrates <- rename("bmid_base" = "X", biocrates)
# 
# metabolInd <- read.csv("/data/KI/imic/data/raw_lab_data/elicit/milk_analytes/MetaboIndicators/Biocrates_ELICIT_Normalized_MetaboINDICATOR.csv")
# metabolInd <- rename("bmid_base" = "X", metabolInd)

# Load VITAL datasets
biocratesNormV <- read.csv("/data/KI/imic/data/raw_lab_data/vital/milk_analytes/Biocrates_VITAL_Normalized_toALL_NS.csv")
biocratesNormV <- rename("bmid_base" = "X", biocratesNormV)
```

Steps taken before implementing PCA:

1) Replaced < LOD with with the minimum observed value for each variable divided by 2.
   Note: after this calculation, some values go to infinity. They have been set to 0.
2) Checked missingness in the data.
3) Removed zero variance variables.
4) Scaled and centered all variables to ensure that the criterion for finding linear combinations of the predictors is based on how much variation they explain and therefore improve numerical stability.

Notes about the following results:

1) Number of components for each dataset has been chosen based on their respective scree plots.
2) Importance has been calculated based on the contribution of a variable to each component. For example, if all variables would contribute equally to each component they would each take up 1/ncol(data). So, any variable that contributes more than 1/ncol(data) to a component can be considered as an important contributor to that component. The vertical line in each plot represents this threshold.
3) Output data from PCA merged with bmid has been saved to "/data/KI/imic/results/pcaData/".

# ELICIT

## Biocrates Normalizes: targeted metabolomics data

### Scree plot
```{r message=FALSE, warning=FALSE, echo=FALSE}
data <- cleanFunc(biocratesNormE)
screePlot(data)
```

### Run PCA and display sample output
```{r, echo=FALSE}
prepData <- prepData(data = data, numC = 10)
pcaEstimates <- pcaEstimates(pca_estimates_prep = prepData)
head(pcaEstimates)
pcaEstimatesPlot <- pcaEstimatesPlot(pcaEstimates = pcaEstimates, PC = 1:10, n = 10)
```

### Top ten contributors to each component based on importance
```{r, echo=FALSE}
top10cI(estimates = pcaEstimatesPlot)
```

### Top 10 contributors to each component by value to see direction
```{r, echo=FALSE}
top10cV(estimates = pcaEstimatesPlot)
```

```{r, echo=FALSE}
# Merge the PC data with ID's and save dataset.
biocratesNormPC <- juice(prepData)
bmid_base = biocratesNormE[, 1]
biocratesNormPC <- cbind(bmid_base, biocratesNormPC)
#saveRDS(biocratesNormPC, file = paste0("/data/KI/imic/results/pcaData/elicit/biocratesNormPC.RDS"))
```








