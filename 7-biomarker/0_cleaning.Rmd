---
title: |
  Cleaning biomarker datasets
author: "Sajia Darwish"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

```{r}
# Make a cleaning function
cleanFunc <- function(data) {
  # data %>%
  #   select(-bmid_base)
  
  # Change <LOD to NA.
  for (i in 1:ncol(data)) {
    data[, i] = ifelse(data[, i] == "< LOD", NA, data[, i])
  }
  
  # Make all variables numeric.
  #str(data)
  #data <- as.data.frame(sapply(data, as.numeric))
  
  # Prepare for test beforehand
  #min(data $C5.OH..C3.DC.M., na.rm = T) / 2 #0.040535 #Correct
  
  # Change these values to min/2.
  data <- data %>% 
    mutate_if(is.numeric, function(x) ifelse(is.na(x), min(x, na.rm = T) / 2, x))
  
  # Change Inf values to 0.
  for (i in 1:ncol(data)) {
    data[, i] = ifelse(data[, i] == "Inf", 0, data[, i])
  }
  
  # Check for missingness.
  table(is.na(data))
  
  # Remove columns with no variance.
  #data <- data[ - as.numeric(which(apply(data, 2, var) == 0))]
  #str(data)
  
  return(data)
}
```

# Biocrates ELICIT
```{r}
library(naniar)

bioc <- readRDS("/data/imic/data/raw_lab_data/elicit/merged_elicit/biocratesNorm.RDS")
#biocClean <- cleanFunc(bioc)

# Filter out obs without Y
bioc <- bioc %>%
  filter(!is.na(haz_6m))

biocClean <- cleanFunc(bioc)

# Convert sex_base to binary.
biocClean $ sex_base = ifelse(biocClean $ sex_base == "Male", 0, 1)

# Look at columns with NA
biocClean <- data.frame(biocClean)
percentMissing <- gg_miss_var(biocClean, show_pct = T)

# Delete columns with 100% NA
newData <- biocClean[, -which(colMeans(is.na(biocClean)) == 1)]
gg_miss_var(newData, show_pct = T)

newData <- newData[ - as.numeric(which(apply(newData, 2, var) == 0))]
gg_miss_var(newData, show_pct = T)

newData <- newData[, -which(colMeans(is.na(newData)) > 0.001)]

# Keep anything less than ~20% LOD and compute values.
# Impute the below LOD values?

saveRDS(newData, file = paste0("/data/imic/data/raw_lab_data/elicit/merged_elicit/biocNormClean.RDS"))
```

# Bvitamins ELICIT
```{r}
# Load data
bvit <- readRDS("/data/imic/data/raw_lab_data/elicit/merged_elicit/bvit.RDS")

# Filter out obs without Y
bvit <- bvit %>%
  filter(!is.na(haz_6m))

bvitClean <- cleanFunc(bvit)

# Convert sex_base to binary.
bvitClean $ sex_base = ifelse(bvitClean $ sex_base == "Male", 0, 1)

# Look at columns with NA
bvitClean <- data.frame(bvitClean)
percentMissing <- gg_miss_var(bvitClean, show_pct = T)

saveRDS(bvitClean, file = paste0("/data/imic/data/raw_lab_data/elicit/merged_elicit/bvitClean.RDS"))
```

# Metabolomics ELICIT
```{r}
# Load data
metabol <- readRDS("/data/imic/data/raw_lab_data/elicit/merged_elicit/metabolInd.RDS")

# Filter out obs without Y
metabol <- metabol %>%
  filter(!is.na(haz_6m))

metabolClean <- cleanFunc(metabol)

# Convert sex_base to binary.
metabolClean $ sex_base = ifelse(metabolClean $ sex_base == "Male", 0, 1)

# Look at columns with NA
metabolClean <- data.frame(metabolClean)
percentMissing <- gg_miss_var(metabolClean, show_pct = T)

saveRDS(metabolClean, file = paste0("/data/imic/data/raw_lab_data/elicit/merged_elicit/metabolClean.RDS"))
```

# Sapient ELICIT
```{r}
sapient <- readRDS("/data/imic/data/raw_lab_data/elicit/merged_elicit/sapient.RDS")

# Filter out obs without Y
sapient <- sapient %>%
  filter(!is.na(haz_6m))

sapientClean <- cleanFunc(sapient)

# Convert sex_base to binary.
sapientClean $ sex_base = ifelse(sapientClean $ sex_base == "Male", 0, 1)

# Look at columns with NA
sapientClean <- data.frame(sapientClean)
percentMissing <- gg_miss_var(sapientClean, show_pct = T)

# Delete columns with 100% NA
newData <- sapientClean[, -which(colMeans(is.na(sapientClean)) == 1)]
gg_miss_var(newData, show_pct = T)

newData <- newData[ - as.numeric(which(apply(newData, 2, var) == 0))]
gg_miss_var(newData, show_pct = T)

newData <- newData[, -which(colMeans(is.na(newData)) > 0.001)]

# Keep anything less than ~20% LOD and compute values.
# Impute the below LOD values?

saveRDS(newData, file = paste0("/data/imic/data/raw_lab_data/elicit/merged_elicit/biocNormClean.RDS"))
```
























