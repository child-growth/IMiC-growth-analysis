---
title: |
  Cleaning biomarker datasets
author: "Sajia Darwish"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

```{r}
# Make a cleaning function
cleanFunc <- function(data) {
  # data %>%
  #   select(-bmid_base)
  
  # Change <LOD to NA.
  for (i in 1:ncol(data)) {
    data[, i] = ifelse(data[, i] == "< LOD", NA, data[, i])
  }
  
  # Make all variables numeric.
  #str(data)
  #data <- as.data.frame(sapply(data, as.numeric))
  
  # Prepare for test beforehand
  #min(data $C5.OH..C3.DC.M., na.rm = T) / 2 #0.040535 #Correct
  
  # Change these values to min/2.
  data <- data %>% 
    mutate_if(is.numeric, function(x) ifelse(is.na(x), min(x, na.rm = T) / 2, x))
  
  # Change Inf values to 0.
  for (i in 1:ncol(data)) {
    data[, i] = ifelse(data[, i] == "Inf", 0, data[, i])
  }
  
  # Check for missingness.
  table(is.na(data))
  
  # Remove columns with no variance.
  #data <- data[ - as.numeric(which(apply(data, 2, var) == 0))]
  #str(data)
  
  return(data)
}
```

# Biocrates ELICIT
```{r}
library(naniar)

bioc <- readRDS("/data/imic/data/raw_lab_data/elicit/merged_elicit/biocratesNorm.RDS")
#biocClean <- cleanFunc(bioc)

# Filter out obs without Y
bioc <- bioc %>%
  filter(!is.na(haz_6m))

biocClean <- cleanFunc(bioc)

# Look at columns with NA
biocClean <- data.frame(biocClean)
percentMissing <- gg_miss_var(biocClean, show_pct = T)

# Delete columns with 100% NA
newData <- biocClean[, -which(colMeans(is.na(biocClean)) == 1)]
gg_miss_var(newData, show_pct = T)

newData <- newData[ - as.numeric(which(apply(newData, 2, var) == 0))]
gg_miss_var(newData, show_pct = T)

newData <- newData[, -which(colMeans(is.na(newData)) > 0.001)]

saveRDS(newData, file = paste0("/data/imic/data/raw_lab_data/elicit/merged_elicit/biocNormClean.RDS"))
```





























